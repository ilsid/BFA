<html>
<head>
<meta charset="utf-8">
<title>Business Flow Automation</title>

<link rel="stylesheet" href="script/dijit/themes/claro/claro.css"/>
<link rel="stylesheet" href="res/styles/custom.css"/>
<style type="text/css">
	html, body {
		width: 100%;
		height: 100%;
		margin: 0;
	}

</style>

</head>
<body class="claro">

	<script src="script/dojo/dojo.js" data-dojo-config="async: true, parseOnLoad: true"></script>
	
	<script>
		// Public functions
		
		function getSelectedGroupName(tree, groupType) {
			var selectedItem = tree.selectedItems[0];
			
			if (selectedItem) {
				if (selectedItem.type == groupType) {
					return selectedItem.name;
				} else {
					// reference to parent item
					return tree.path[tree.path.length - 2].name;
				}
			} else {
				return null;
			}
		}
		
		function escapeScriptSource(source)  {
			return source.replace(/"/g,'\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r').replace(/\t/g, '\\t');
		}
		
		function showCreateGroupDialog(treeId, groupType) {
			require([ 'dijit/registry'],
				function(registry) {
					var tree = registry.byId(treeId);
					var selectedGroupName = getSelectedGroupName(tree, groupType);
					var groupText = registry.byId('createGroupDialog_textGroupName');
					var parentGroupText = registry.byId('createGroupDialog_textParentGroup');
					var topLevelCheckBox = registry.byId('createGroupDialog_checkTopLevel');
					
					if (selectedGroupName != null) {
						parentGroupText.set('value', selectedGroupName);
						topLevelCheckBox.set('checked', false);
						topLevelCheckBox.set('disabled', false);
					} else {
						parentGroupText.set('value', '');
						topLevelCheckBox.set('checked', true);
						topLevelCheckBox.set('disabled', true);
					}
					groupText.set('value', '');
					groupText.reset();
					registry.byId('createGroupDialog').show();
				});
		}
		
		function showCreateScriptDialog() {
			require([ 'dijit/registry'],
				function(registry) {
					var tree = registry.byId('scriptsTree');
					var selectedGroupName = getSelectedGroupName(tree, 'SCRIPT_GROUP');
					var groupText = registry.byId('createScriptDialog_textGroupName');
					var scriptText = registry.byId('createScriptDialog_textScriptName');
					
					if (selectedGroupName != null) {
						groupText.set('value', selectedGroupName);
					} else {
						groupText.set('value', '');
					}
					scriptText.set('value', '');
					scriptText.reset();
					registry.byId('createScriptDialog').show();
				});
		}

		function hideDialog(id) {
			require([ 'dijit/registry'],
				function(registry) {
					registry.byId(id).hide();
				});
		}		

		function onCreateGroupDialog_checkTopLevelClick() {
			require([ 'dijit/registry'],
				function(registry) {
					var checkBox = registry.byId('createGroupDialog_checkTopLevel');
					var tree = registry.byId('scriptsTree');
					var parentGroupText = registry.byId('createGroupDialog_textParentGroup');
					if (checkBox.checked) {
						parentGroupText.set('value', '');
					} else {
						var selectedGroupName = getSelectedGroupName(tree, 'SCRIPT_GROUP');
						parentGroupText.set('value', selectedGroupName);
					}
				});
		}
		
		function onCreateGroupDialog_btnOkClick() {
			require([ 'dijit/registry', 'dojo/request/xhr'],
				function(registry, request) {
					var groupText = registry.byId('createGroupDialog_textGroupName');
					if (!groupText.isValid()) {
						return;
					}
					
					var parentGroupName = null;
					var tree = registry.byId('scriptsTree');
					if (!registry.byId('createGroupDialog_checkTopLevel').checked) {
						parentGroupName = getSelectedGroupName(tree, 'SCRIPT_GROUP');
					} 
					
					var groupName = groupText.get('value');
					if (parentGroupName != null) {
						groupName = parentGroupName + '::' + groupName;
					}
					
					request('service/script/admin/createGroup', {
							headers: { 'Content-Type': 'text/plain' },
							method: 'POST',
							data: groupName
						}).then(function(resp){
							var parentId = parentGroupName != null ? parentGroupName : tree.rootName; 
							tree.refreshChildrenSubTree(parentId);
							hideDialog('createGroupDialog');
						}, function(err) {
							alert('Server request failed. Please contact support staff');
						});
				});
		}
		
		function onCreateScriptDialog_btnOkClick() {
			require([ 'dijit/registry', 'dojo/request/xhr'],
				function(registry, request) {
					var textScript = registry.byId('createScriptDialog_textScriptName');
					if (!textScript.isValid()) {
						return;
					}
					
					var tree = registry.byId('scriptsTree');
					var groupName = getSelectedGroupName(tree, 'SCRIPT_GROUP');
					// group name can't be null, as script creation is enabled only if some group is selected
					var scriptShortName = textScript.get('value');
					var scriptName = groupName + '::' + scriptShortName;
					
					var tabContainer = registry.byId('tabContainer');
					var scriptTab = tabContainer.selectedChildWidget;
					var scriptArea = scriptTab.getChildren()[1];
					var scriptSource = scriptArea.get('value');
					var scriptBody = escapeScriptSource(scriptSource);
					
					request('service/script/admin/create', {
							headers: { 'Content-Type': 'application/json' },
							method: 'POST',
							data: '{"name": "' + scriptName +'", "body": "' + scriptBody + '"}'
						}).then(function(resp){
							tree.refreshChildrenSubTree(groupName);
							hideDialog('createScriptDialog');
							var tabIdx = tabContainer.getIndexOfChild(scriptTab);
							tabContainer.removeChild(scriptTab);
							scriptTab.destroyRecursive();
							createScriptTab(scriptShortName, 'tab_' + scriptName, 'scriptArea_' + scriptName, 
								scriptSource, tabIdx);
						}, function(err) {
							alert('Server request failed. Please contact support staff');
						});
				});
		}
		
		function createScriptTab(tabTitle, tabId, textAreaId, textAreaValue, indexInContainer) {
			require([ 'dijit/registry', 'dijit/layout/ContentPane', 'dijit/form/SimpleTextarea', 
				'dijit/Toolbar', 'dijit/form/Button', 'dojo/domReady!'],
				function(registry, ContentPane, SimpleTextarea, Toolbar, Button) {
					var tabContainer = registry.byId('tabContainer');
					
					var tab = new ContentPane({
						id: tabId,
						title: tabTitle,
						closable: true,
						iconClass: 'dijitLeaf',
						style: 'overflow: auto;'
					});
					
					var isExistingScript = (tabId != undefined);
					
					var saveButton = new Button({
						label: 'Save',
						showLabel: false,
						iconClass: 'dijitIconSave',
						onClick: function() {
							showCreateScriptDialog();
						}
					});
					if (isExistingScript) {
						// TODO: Support of script update
						saveButton.set('disabled', true);
					}
					saveButton.startup();
					
					var toolBar = new Toolbar();
					toolBar.addChild(saveButton);
					toolBar.startup();
				
					var scriptArea = new SimpleTextarea({
						id: textAreaId,
						className: 'fixedTextArea'
					});
					if (textAreaValue) {
						scriptArea.set('value', textAreaValue);
					}
					scriptArea.startup();
					
					tab.addChild(saveButton);
					tab.addChild(scriptArea);
					
					if (indexInContainer > -1) {
						tabContainer.addChild(tab, indexInContainer);
					} else {
						tabContainer.addChild(tab);
					}
					tabContainer.selectChild(tab);
			});
		}
		
	</script>

	
	<script>
		require(["dijit/Dialog", "dijit/form/TextBox", "dijit/form/ValidationTextBox"]);
	</script>
	
	<div data-dojo-type="dijit/Dialog" id="createGroupDialog" title="Create group" style="display: none">
		<table class="dijitDialogPaneContentArea">
			<tr>
				<td><label for="createGroupDialog_textParentGroup">Parent group:</label></td>
				<td><input data-dojo-type="dijit/form/TextBox" data-dojo-props="disabled:true" id="createGroupDialog_textParentGroup" name="createGroupDialog_textParentGroup"></td>
			</tr>
			<tr>
				<td><label for="createGroupDialog_textGroupName">Name:</label></td>
				<td><input data-dojo-type="dijit/form/ValidationTextBox" id="createGroupDialog_textGroupName" name="createGroupDialog_textGroupName" 
					required="true" data-dojo-props="missingMessage:'The value is required'" /></td>
			</tr>
			<tr>
				<td><input data-dojo-type="dijit/form/CheckBox" id="createGroupDialog_checkTopLevel" name="createGroupDialog_checkTopLevel" 
					onclick="onCreateGroupDialog_checkTopLevelClick();" /> 
					<label for="createGroupDialog_checkTopLevel">Is top-level group</label></td>
			</tr>
		</table>
		<div class="dijitDialogPaneActionBar">
			<button data-dojo-type="dijit/form/Button" type="button" id="createGroupDialog_btnOk" onclick="onCreateGroupDialog_btnOkClick();">OK</button>
			<button data-dojo-type="dijit/form/Button" type="button" id="createGroupDialog_btnCancel" onclick="hideDialog('createGroupDialog');">Cancel</button>
		</div>
	</div>
	
	<div data-dojo-type="dijit/Dialog" id="createScriptDialog" title="Save script" style="display: none">
		<table class="dijitDialogPaneContentArea">
			<tr>
				<td><label for="createScriptDialog_textGroupName">Group:</label></td>
				<td><input data-dojo-type="dijit/form/TextBox" data-dojo-props="disabled:true" id="createScriptDialog_textGroupName" name="createScriptDialog_textGroupName"></td>
			</tr>
			<tr>
				<td><label for="createScriptDialog_textScriptName">Name:</label></td>
				<td><input data-dojo-type="dijit/form/ValidationTextBox" id="createScriptDialog_textScriptName" name="createScriptDialog_textScriptName" 
					required="true" data-dojo-props="missingMessage:'The value is required'" /></td>
			</tr>
		</table>
		<div class="dijitDialogPaneActionBar">
			<button data-dojo-type="dijit/form/Button" type="button" id="createScriptDialog_btnOk" onclick="onCreateScriptDialog_btnOkClick();">Save</button>
			<button data-dojo-type="dijit/form/Button" type="button" id="createScriptDialog_btnCancel" onclick="hideDialog('createScriptDialog');">Cancel</button>
		</div>
	</div>

	<script>
		require(["dojo/parser", "dijit/layout/BorderContainer", "dijit/layout/TabContainer", "dijit/layout/AccordionContainer", 
		         "dijit/layout/ContentPane", "dijit/layout/AccordionPane"]);
	</script>
	
	<div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="gutters:true, isLayoutContainer:true" style="width: 100%; height: 100%;">
		 <div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'">
			<h4 id="greeting">Business Flows Automation</h4>
		 </div>
		 <div data-dojo-type="dijit/layout/AccordionContainer" data-dojo-props="region:'leading', splitter:true" style="width: 20%;" id='accordionContainer'>
			<div data-dojo-type="dijit/layout/AccordionPane" title="Scripts" id="scriptsPane;">
				<div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="isLayoutContainer:true" style="width: 100%; height: 100%; margin: 0; padding: 0;">
					<div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'" style="border: none; margin: 0; padding: 0;">
						<div id="scriptsToolbar" data-dojo-type="dijit/Toolbar">
							<div data-dojo-type="dijit/form/Button" id="scriptsToolbar_newGroup" data-dojo-props="iconClass:'dijitFolderClosed', showLabel:false" 
								onclick="showCreateGroupDialog('scriptsTree', 'SCRIPT_GROUP')">New Group</div>
							<div data-dojo-type="dijit/form/Button" id="scriptsToolbar_newScript" data-dojo-props="iconClass:'dijitLeaf', showLabel:false" disabled="true"
								onclick="createScriptTab('New Script');">New Script</div>
							<div data-dojo-type="dijit/form/Button" id="scriptsToolbar_deleteGroup" data-dojo-props="iconClass:'toolbarIconDeleteFolder', showLabel:false"
								disabled="true">Delete Group</div>
							<div data-dojo-type="dijit/form/Button" id="scriptsToolbar_deleteScript" data-dojo-props="iconClass:'toolbarIconDeleteItem', showLabel:false"
								disabled="true">Delete Script</div>
						</div>
					</div>
					<div data-dojo-type="dijit/layout/ContentPane"  data-dojo-props="region:'center'" style="border: none; margin: 0; padding: 0;">
						<div id="scriptsTreeContainer" style="height: 100%;"></div>
					</div>
				</div>	
			</div>
			<div data-dojo-type="dijit/layout/AccordionPane" title="Entities" id="entitiesPane">
			</div>
			<div data-dojo-type="dijit/layout/AccordionPane" title="Actions" id="actionsPane">
			</div>
		 </div>
		 
		<div data-dojo-type="dijit/layout/TabContainer" data-dojo-props="region:'center', splitter:true, tabStrip:true" id="tabContainer">
		</div>
	</div>

	<script>
		require([ 'dojo/request/xhr', 'dojo/dom', 'dojo/store/Memory', 'dijit/tree/ObjectStoreModel', 'dijit/Tree', 'dojo/store/Observable', 
				'dijit/registry', 'dojo/domReady!' ], 
			function(request, dom, Memory, ObjectStoreModel, Tree, Observable, registry) {
			
				var rootName = '__root';
				
				var treeStore = new Memory({
					data: [{name: rootName}],
					idProperty: 'name',
					
					getChildren: function(object){
						return request('service/script/admin/getItems', {
							headers: { 'Content-Type': 'text/plain' },
							method: 'POST',
							data: object.name,
							handleAs: 'json'
						}).then(function(resp) {
							return resp;
						}, function(err) {
							alert('Server request failed. Please contact support staff');
						});
					}
				});
				
				var treeModel = new ObjectStoreModel({
					store: treeStore,
					getLabel: function(item){ return item.title; },
					mayHaveChildren: function(item){ return item.type == 'SCRIPT_GROUP'; },
					query: {name: rootName}
				});
				
				var tree = new Tree({
					id: 'scriptsTree',
					model: treeModel,
					showRoot: false,
					openOnClick: false,
					rootName: rootName,
					
					onFocus: function() {
						var btnNewScript = registry.byId('scriptsToolbar_newScript');
						if (btnNewScript.disabled) {
							btnNewScript.set('disabled', false);
						}
					},
					
					onClick: function(item, node) {
						//Warning! Depends on internal implementation of Tree: _expandNode() function
						if (this.model.mayHaveChildren(item)) {
							if (node.isExpanded) {
								node.collapse();	
							} else {
								this._expandNode(node);
							}
						}
						
						var btnDeleteGroup = registry.byId('scriptsToolbar_deleteGroup');
						var btnDeleteScript = registry.byId('scriptsToolbar_deleteScript');
						if (this.model.mayHaveChildren(item)) {
							btnDeleteGroup.set('disabled', false);
							btnDeleteScript.set('disabled', true);
						} else {
							btnDeleteGroup.set('disabled', true);
							btnDeleteScript.set('disabled', false);
						}
					},
					
					onDblClick: function(item) {
						if (this.model.mayHaveChildren(item)) {
							return;
						}
						var tabContainer = registry.byId('tabContainer');
						var tabId = 'tab_' + item.name;
						
						var oldTab = registry.byId(tabId);
						if (oldTab) {
							tabContainer.selectChild(oldTab);
							return;
						}
						
						request('service/script/admin/getSource', {
							headers: { 'Content-Type': 'application/json' },
							method: 'POST',
							data: '{"name": "' + item.name + '"}'
						}).then(function(resp){
							createScriptTab(item.title, tabId, 'scriptArea_' + item.name, resp);
						}, function(err) {
							alert('Server request failed. Please contact support staff');
						});
					},
					
					refreshChildrenSubTree: function(itemId) {
						//Warning! Depends on internal implementation of Tree and ObjectStoreModel
						delete this.model.childrenCache[itemId];
						var node = this._itemNodesMap[itemId][0];
						delete node._loadDeferred;
						this._expandNode(node);
					}
				});
				
				tree.placeAt(dom.byId('scriptsTreeContainer'));
				tree.startup();
			});
	</script>


</body>
</html>