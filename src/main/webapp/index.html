<html>
<head>
<meta charset="utf-8">
<title>Business Flow Automation</title>

<link rel="stylesheet" href="script/dijit/themes/claro/claro.css"/>
<link rel="stylesheet" href="res/styles/toolbar.css"/>
<style type="text/css">
	html, body {
		width: 100%;
		height: 100%;
		margin: 0;
	}

</style>

</head>
<body class="claro">

	<script src="script/dojo/dojo.js" data-dojo-config="async: true, parseOnLoad: true"></script>
	<script>
		require(["dojo/parser", "dijit/layout/BorderContainer", "dijit/layout/TabContainer", "dijit/layout/AccordionContainer", 
		         "dijit/layout/ContentPane", "dijit/layout/AccordionPane"]);
	</script>
	
	
	<div data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="gutters:true, isLayoutContainer:true" style="width: 100%; height: 100%;">
		 <div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'">
			<h4 id="greeting">BFA</h4>
		 </div>
		 <div data-dojo-type="dijit/layout/AccordionContainer" data-dojo-props="region:'leading', splitter:true" style="width: 20%;" id='accordionContainer'>
			<div data-dojo-type="dijit/layout/AccordionPane" title="Scripts" id="scriptsPane">
				<div id="scriptsToolbar" data-dojo-type="dijit/Toolbar">
					<div data-dojo-type="dijit/form/Button" id="scriptsToolbar_newGroup" data-dojo-props="iconClass:'dijitFolderClosed', showLabel:false">New Group</div>
					<div data-dojo-type="dijit/form/Button" id="scriptsToolbar_newScript" data-dojo-props="iconClass:'dijitLeaf', showLabel:false">New Script</div>
					<div data-dojo-type="dijit/form/Button" id="scriptsToolbar_deleteGroup" data-dojo-props="iconClass:'toolbarIconDeleteFolderItem', showLabel:false">Delete Group</div>
					<div data-dojo-type="dijit/form/Button" id="scriptsToolbar_deleteScript" data-dojo-props="iconClass:'toolbarIconDeleteItem', showLabel:false">Delete Script</div>
				</div>
				<div id="scriptsTree" style="height: 100%;"></div>
			</div>
			<div data-dojo-type="dijit/layout/AccordionPane" title="Entities" id="entitiesPane">
			</div>
			<div data-dojo-type="dijit/layout/AccordionPane" title="Actions" id="actionsPane">
			</div>
		 </div>
		 
		<div data-dojo-type="dijit/layout/TabContainer" data-dojo-props="region:'center', splitter:true, tabStrip:true" id="tabContainer">
		</div>
	</div>

	<script>
		require([ 'dojo/dom', 'dojo/dom-construct', 'dojo/domReady!' ],
				function(dom, domConstruct, fx) {
					var greetingNode = dom.byId('greeting');
					domConstruct.place('<em> Prototyping...</em>', greetingNode);
				});
	</script>
	
	<script>
		require([ 'dojo/request/xhr', 'dojo/dom', 'dojo/store/Memory', 'dijit/tree/ObjectStoreModel', 'dijit/Tree', 'dojo/store/Observable', 
				'dijit/registry', 'dijit/layout/ContentPane', 'dijit/form/Textarea', 'dojo/domReady!' ], 
			function(request, dom, Memory, ObjectStoreModel, Tree, Observable, registry, ContentPane, Textarea) {
			
				var rootName = '__root';
				
				var treeStore = new Memory({
					data: [{name: rootName}],
					idProperty: 'name',
					
					getChildren: function(object){
						return request('service/script/admin/getItems', {
							headers: { 'Content-Type': 'text/plain' },
							method: 'POST',
							data: object.name,
							handleAs: 'json'
						}).then(function(resp) {
							return resp;
						}, function(err) {
							alert('Server request failed. Please contact support staff');
						});
					}
				});
				treeStore = new Observable(treeStore);
				
				var treeModel = new ObjectStoreModel({
					store: treeStore,
					getLabel: function(item){ return item.title; },
					mayHaveChildren: function(item){ return item.type == 'SCRIPT_GROUP'; },
					query: {name: rootName}
				});
				
				var tree = new Tree({
					model: treeModel,
					showRoot: false,
					openOnClick: true,
					
					onDblClick: function(item) {
						if (this.model.mayHaveChildren(item)) {
							return;
						}
						var tabContainer = registry.byId('tabContainer');
						var tabId = 'tab_' + item.name;
						
						var oldTab = registry.byId(tabId);
						if (oldTab) {
							tabContainer.selectChild(oldTab);
							return;
						}
						
						request('service/script/admin/getSource', {
							headers: { 'Content-Type': 'application/json' },
							method: 'POST',
							data: '{"name": "' + item.name + '"}'
						}).then(function(resp){
							var tab = new ContentPane({
								id: tabId,
								title: item.title,
								closable: true
							});
							var scriptArea = new Textarea({
								id: 'scriptArea_' + item.name,
								value: resp
							});
							tab.addChild(scriptArea);
							tabContainer.addChild(tab);
							tabContainer.selectChild(tab);
						}, function(err) {
							alert('Server request failed. Please contact support staff');
						});
					}
				});
				
				tree.placeAt(dom.byId('scriptsTree'));
				tree.startup();
			});
	</script>


</body>
</html>